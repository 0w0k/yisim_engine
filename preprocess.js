#!/usr/bin/env bun

import { preprocessJavaScript } from './preprocessor.js';
import fs from 'fs';

// HAS_SHADOW_OWL_REISHI -> HAS_FLYING_BRUSH

const deps = {
    HAS_BAD_OMEN: ["37204", "bad_omen_stacks"],
    HAS_BLOSSOM_DANCE: ["blossom_dance_stacks"],
    HAS_COURAGE_TO_FIGHT: ["courage_to_fight_stacks"],
    HAS_COVERT_SHIFT: ["22602", "covert_shift_stacks"],
    HAS_CRASH_FIST_ENTANGLE: ["14202", "crash_fist_entangle_stacks"],
    HAS_CYCLE_OF_FIVE_ELEMENTS_AND_FRIENDS: [
        "HAS_P2_CYCLE_OF_FIVE_ELEMENTS",
        "HAS_P3_CYCLE_OF_FIVE_ELEMENTS",
        "HAS_P4_CYCLE_OF_FIVE_ELEMENTS",
        "HAS_P5_CYCLE_OF_FIVE_ELEMENTS",
        "HAS_BLOSSOM_DANCE"],
    HAS_P2_CYCLE_OF_FIVE_ELEMENTS: ["p2_cycle_of_five_elements_stacks"],
    HAS_P3_CYCLE_OF_FIVE_ELEMENTS: ["p3_cycle_of_five_elements_stacks"],
    HAS_P4_CYCLE_OF_FIVE_ELEMENTS: ["p4_cycle_of_five_elements_stacks"],
    HAS_P5_CYCLE_OF_FIVE_ELEMENTS: ["p5_cycle_of_five_elements_stacks"],
    HAS_ENTANGLING_ANCIENT_VINE: ["36503", "entangling_ancient_vine_stacks"],
    HAS_FIRE_FLAME_BLADE: ["fire_flame_blade_stacks"],
    HAS_GUARD_UP: ["HAS_PEACH_BRANCH_RUYI", "guard_up",
        "36403", "12409", "24302", "31501", "34402", "40501",
        "40502", "60509", "61502", "90403", "91503", "91601"],
    HAS_PEACH_BRANCH_RUYI: ["peach_branch_ruyi_stacks"],
    HAS_IGNORE_GUARD_UP: ["91601", "ignore_guard_up"],
    HAS_INTERNAL_INJURY: ["HAS_TOXIC_PURPLE_FERN",
        "HAS_MARK_OF_DARK_HEART",
        "HAS_HEARTBROKEN_TUNE",
        "HAS_MEDITATION_OF_XUAN",
        "HAS_CACOPOISONOUS_FORMATION",
        "HAS_ZONGZI_MODE",
        "internal_injury",
        "12210", "12307", "12410", "14108", "14308", "14505",
        "14506", "22401", "24401", "24501", "24502", "32202",
        "32303", "32503", "33403", "34301", "37303", "37501",
        "40301", "60301", "60507", "60601", "62303", "64301",
        "72502", "92401", "94402"],
    HAS_MARK_OF_DARK_HEART: ["HAS_P2_MARK_OF_DARK_HEART",
        "HAS_P2_MARK_OF_DARK_HEART",
        "HAS_P4_MARK_OF_DARK_HEART",
        "HAS_P5_MARK_OF_DARK_HEART"],
    HAS_P2_MARK_OF_DARK_HEART: ["p2_mark_of_dark_heart_stacks"],
    HAS_P3_MARK_OF_DARK_HEART: ["p3_mark_of_dark_heart_stacks"],
    HAS_P4_MARK_OF_DARK_HEART: ["p4_mark_of_dark_heart_stacks"],
    HAS_P5_MARK_OF_DARK_HEART: ["p5_mark_of_dark_heart_stacks"],
    HAS_METAL_SPIRIT_GIANT_TRIPOD: ["13504", "metal_spirit_giant_tripod_stacks"],
    HAS_PENETRATE: ["13108", "13207", 
        "13308", "13407", "23104", "63401", "73502", "13307",
        "p5_cycle_of_five_elements_stacks",
        "five_elements_anima_stacks",
        "HAS_METAL_SPIRIT_RHYTHM_WATER",
        "penetrate"],
    HAS_TOXIC_PURPLE_FERN: ["toxic_purple_fern_stacks"],
    HAS_WATER_SPIRIT_SPRING: ["13310", "water_spirit_spring_stacks"],
    HAS_WOUND: ["wound", "HAS_CRASH_FIST_ENTANGLE",
        "HAS_ENTANGLING_ANCIENT_VINE",
        "HAS_BAD_OMEN",
        "HAS_COURAGE_TO_FIGHT",
        "14107", "14308", "14506", "22401", "24501", "24502",
        "32202", "33403", "34301", "60302", "60503", "60602",
        "61501", "64301"],
    HAS_DECREASE_ATK: ["HAS_ANTHOMANIA_FORMATION", "decrease_atk",
        "14407", "14506", "22401", "24501", "32202", "33403",
        "34301", "64301"],
    HAS_IGNORE_DECREASE_ATK: ["14506", "ignore_decrease_atk"],
    HAS_WEAKEN: ["weaken",
        "12208", "12402", "14207", "14506", "22102", "22401",
        "24501", "24502", "32202", "32403", "32503", "33403",
        "34301", "40401", "60504", "64301", "90403"],
    HAS_IGNORE_WEAKEN: ["14506", "21302", "ignore_weaken"],
    HAS_FLAW: ["flaw",
        "12304", "14206", "14506", "22102", "22401", "24501",
        "24502", "32202", "32402", "32503", "33403", "34301",
        "40402", "60509", "61101", "64301"],
    HAS_ENTANGLE: ["entangle",
        "14305", "14506", "22401", "24501", "24502", "32202",
        "33403", "34301", "36503", "40503", "60507", "64301",
        "90602"],
    HAS_STYX: ["styx", "HAS_ENTERING_STYX",
        "14506", "22401", "24501", "32202", "33403", "64301",
        "64401", "64501", "94401"],
    HAS_ENTERING_STYX: ["entering_styx_stacks"],
    HAS_PREVENT_ANTI_CHASE: ["prevent_anti_chase",
        "93601", "60603"],
    HAS_EXTRA_MAX_CHASES: ["max_chases", "60603"],
    HAS_PREDICAMENT_FOR_IMMORTALS: ["predicament_for_immortals_stacks",
        "33501"],
    HAS_ACTIVATE_WOOD: ["activate_wood_spirit_stacks",
        "HAS_ACTIVATE_ANY",
        "13101", "23101", "63201", "63302", "93601"],
    HAS_ACTIVATE_FIRE: ["activate_fire_spirit_stacks",
        "HAS_ACTIVATE_ANY",
        "13103", "23102", "63302", "93301", "93401", "93601"],
    HAS_ACTIVATE_EARTH: ["activate_earth_spirit_stacks",
        "HAS_ACTIVATE_ANY",
        "13105", "23103", "63301", "63302", "93301", "93601"],
    HAS_ACTIVATE_METAL: ["activate_metal_spirit_stacks",
        "HAS_ACTIVATE_ANY",
        "13107", "23104", "63301", "63302", "93601"],
    HAS_ACTIVATE_WATER: ["activate_water_spirit_stacks",
        "HAS_ACTIVATE_ANY",
        "13109", "23105", "63302", "93401", "93601"],
    HAS_ACTIVATE_ANY: ["13311", "63402", "93502",
        "HAS_COSMOS_SEAL", "HAS_ACTIVATE_NEXT"],
    HAS_COSMOS_SEAL: ["HAS_MARK_OF_FIVE_ELEMENTS", "13211"],
    HAS_ACTIVATE_NEXT: ["93201"],
    HAS_MARK_OF_FIVE_ELEMENTS: ["mark_of_five_elements_stacks"],
    HAS_ZONGZI_MODE: [],
    HAS_CORAL_SWORD: ["coral_sword_stacks"],
    HAS_IGNORE_DEF: ["ignore_def", "HAS_CORAL_SWORD",
        "11106", "11302", "13208", "14207", "31201", "33101",
        "33303", "61201", "91401", "91601"],
    HAS_SMASH_DEF: ["smash_def",
        "HAS_FRACCIDE_FORMATION",
        "HAS_LEAF_BLADE_FLOWER",
        "HAS_CRASH_FIST_BLITZ",
        "13302", "13411", "14203", "14209", "91507"],
    HAS_FRACCIDE_FORMATION: ["fraccide_formation_stacks", "35102"],
    HAS_LEAF_BLADE_FLOWER: ["leaf_blade_flower_stacks", "36204"],
    HAS_CRASH_FIST_BLITZ: ["crash_fist_blitz_stacks", "14203",
        "this_card_crash_fist_blitz_stacks"],
    HAS_NEXT_TURN_DEF: ["next_turn_def", "HAS_EARTH_SPIRIT_DUST",
        "11309", "13206", "23103", "90405"],
    HAS_EARTH_SPIRIT_DUST: ["13305"],
    HAS_INCREASE_ATK: ["increase_atk", "HAS_COURAGE_TO_FIGHT",
        "HAS_STEP_MOON_INTO_CLOUD",
        "HAS_WOOD_SPIRIT_ALL_THINGS_GROW",
        "HAS_HEAVENLY_SPIRIT_FORCEAGE_FORMATION",
        "HAS_XUANMING_FORCEAGE_FORMATION",
        "HAS_FIVE_ELEMENTS_ANIMA",
        "sword_pattern_carving_charge_stacks",
        "11402", "13201", "13202", "13304", "13401", "13501",
        "14503", "21202", "23101", "24302", "24401", "31302",
        "40303", "60503", "64502", "91507"],
    HAS_STEP_MOON_INTO_CLOUD: ["step_moon_into_cloud_stacks", "21502"],
    HAS_WOOD_SPIRIT_ALL_THINGS_GROW: ["93503",
        "wood_spirit_all_things_grow_stacks"],
    HAS_HEAVENLY_SPIRIT_FORCEAGE_FORMATION: ["35401",
        "heavenly_spirit_forceage_formation_stacks"],
    HAS_XUANMING_FORCEAGE_FORMATION: ["90404",
        "xuanming_forceage_formation_stacks"],
    HAS_FIVE_ELEMENTS_ANIMA: ["five_elements_anima_stacks"],
    HAS_REGEN: ["regen", "HAS_MARK_OF_DARK_HEART",
        "HAS_MEDITATION_OF_XUAN",
        "40302", "61402", "80102", "80302", "80503", "94402"],
    HAS_MEDITATION_OF_XUAN: ["meditation_of_xuan_stacks", "64402"],
    HAS_RESONANCE_LANDSLIDE: ["resonance_landslide_stacks"],
    HAS_THREE_TAILED_CAT: ["three_tailed_cat_stacks", "50403"],
    HAS_HEXPROOF: ["hexproof", "HAS_THREE_TAILED_CAT",
        "14211", "35303", "37401", "80205"],
    HAS_ELUSIVE_FOOTWORK: ["elusive_footwork_stacks", "14406"],
    HAS_STYX_NIGHT_FOOTWORK: ["styx_night_footwork_stacks", "94401"],
    HAS_BEAST_SPIRIT_SWORD_FORMATION: [
        "beast_spirit_sword_formation_stacks", "71502"],
    HAS_METAL_SPIRIT_IRON_BONE: ["metal_spirit_iron_bone_stacks",
        "13408"],
    HAS_WATER_SPIRIT_DIVE: ["water_spirit_dive_stacks", "13410"],
    HAS_EVERYTHING_GOES_WAY: ["everything_goes_way_stacks", "37401"],
    HAS_HEAVENLY_WILL_COMPLY: ["god_opportunity_conform_stacks",
        "37503"],
    HAS_HEAVENLY_WILL_DEFY: ["god_opportunity_reversal_stacks",
        "37504"],
    HAS_FLAME_SOUL_REBIRTH: ["flame_soul_rebirth_stacks"],
    HAS_XUANMING_RECURRING: ["90301"],
    HAS_BLACK_EARTH_TURTLE: ["black_earth_turtle_stacks", "50301"],
    HAS_MOON_WATER_SWORD_FORMATION: ["moon_water_sword_formation_stacks",
        "11409", "HAS_SWORD_FORMATION_GUARD"],
    HAS_FAT_IMMORTAL_RACCOON: ["fat_immortal_raccoon_stacks", "50102"],
    HAS_SCARLET_EYE_THE_SKY_CONSUMER: [
        "scarlet_eye_the_sky_consumer_stacks", "50401"],
    HAS_BREAK_SKY_EAGLE: ["break_sky_eagle_stacks", "50101"],
    HAS_VOID_THE_SPIRIT_CONSUMER: ["void_the_spirit_consumer_stacks",
        "50601"],
    HAS_SPIRIT_GATHER_CITTA_DHARMA: ["spirit_gather_citta_dharma_stacks",
        "11403"],
    HAS_APEX_SWORD_CITTA_DHARMA: ["apex_sword_citta_dharma_stacks",
        "21501"],
    HAS_HEARTBROKEN_TUNE: ["heartbroken_tune_stacks", "33301"],
    HAS_ILLUSION_TUNE: ["illusion_tune_stacks", "33202"],
    HAS_CACOPOISONOUS_FORMATION: ["cacopoisonous_formation_stacks",
        "35202"],
    HAS_SPIRITAGE_FORMATION: ["spiritage_formation_stacks", "35301"],
    HAS_ULTIMATE_HEXAGRAM_BASE: ["ultimate_hexagram_base_stacks",
        "62301"],
    HAS_QI_GATHERING_MERPEOPLE_PEARL: [
        "qi_gathering_merpeople_pearl_stacks", "60502"],
    HAS_ULTIMATE_POLARIS_HEXAGRAM_BASE: [
        "ultimate_polaris_hexagram_base_stacks", "92501"],
    HAS_WATER_SPIRIT_SPRING_RAIN: [
        "water_spirit_spring_rain_stacks", "63403"],
    HAS_NUWA_STONE: ["nuwa_stone_stacks", "90601"],
    HAS_ASHES_PHOENIX: ["ashes_phoenix_stacks", "50402"],
    HAS_HEAVENLY_MAIDEN_WHITE_JADE_RING: [
        "heavenly_maiden_white_jade_ring_stacks", "92601"],
    HAS_CANNOT_ACT: ["cannot_act_stacks", "heptastar_soulstat_stacks",
        "23502", "40602", "62401"],
    HAS_REVIVE: ["HAS_ASHES_PHOENIX", "HAS_FLAME_SOUL_REBIRTH",
        "HAS_HEAVENLY_MAIDEN_WHITE_JADE_RING"],
    HAS_SHADOW_OWL_RABBIT: ["shadow_owl_rabbit_stacks", "50502"],
    HAS_OCTGATES_LOCK_FORMATION: [
        "octgates_lock_formation_stacks", "35402"],
    HAS_DEVOURING_ANCIENT_VINE: [
        "devouring_ancient_vine_stacks", "36504"],
    HAS_SKIP_TO_PREVIOUS_CARD: ["skip_to_previous_card_stacks",
        "37302", "90301"],
    HAS_SKIP_NEXT_CARD: ["skip_next_card_stacks",
        "12502", "35503", "37301", "80406", "90603"],
    HAS_CYCLE_OF_FATE: ["fate_reincarnates_stacks", "37502"],
    HAS_ASTRAL_MOVE_JUMP: ["astral_move_jump_stacks", "92509"],
    HAS_SKIP_ONE_PLAY: ["36502"],
    HAS_WATER_SPIRIT_COST_0_QI: ["13209"],
    HAS_REDUCE_QI_COST_ON_STAR_POINT: [
        "reduce_qi_cost_on_star_point_stacks", "62501"],
    HAS_INSPIRATION: ["inspiration_stacks", "34302"],
    HAS_MOUNTAIN_CLEAVING_PALMS: ["14105"],
    HAS_UNBOUNDED_QI: ["unbounded_qi_stacks"],
    HAS_GATHER_QI: ["90601", "90602", "90605", "90607", "91601",
        "92601", "93601"],
    HAS_REST_AND_OUTWIT: ["rest_and_outwit_stacks"],
    HAS_CRACKING_FIST: ["cracking_fist_stacks"],
    HAS_CRASH_FIST_BOUNCE: ["crash_fist_bounce_stacks", "14103"],
    HAS_CRASH_FIST_RETURN_TO_XUAN: [
        "crash_fist_return_to_xuan_stacks", "94402"],
    HAS_REFUND_HP_COST: ["HAS_CRASH_FIST_BOUNCE",
        "HAS_CRASH_FIST_RETURN_TO_XUAN"],
    HAS_FINISHING_TOUCH: [
        "finishing_touch_stacks", "34502", "91501"],
    HAS_CLOUD_SWORD_DRAGON_SPRING: ["91501"],
    HAS_P2_MUTUAL_GROWTH: ["p2_mutual_growth_stacks"],
    HAS_P3_MUTUAL_GROWTH: ["p3_mutual_growth_stacks"],
    HAS_P4_MUTUAL_GROWTH: ["p4_mutual_growth_stacks"],
    HAS_P5_MUTUAL_GROWTH: ["p5_mutual_growth_stacks"],
    HAS_MUTUAL_GROWTH: [
        "HAS_P2_MUTUAL_GROWTH", "HAS_P3_MUTUAL_GROWTH",
        "HAS_P4_MUTUAL_GROWTH", "HAS_P5_MUTUAL_GROWTH"],
    HAS_NETHER_VOID_CANINE: ["nether_void_canine_stacks", "50602"],
    HAS_KONGTONG_SEAL: ["kongtong_seal_stacks", "90604"],
    HAS_SPIRIT_FUSION_POT: ["spirit_fusion_pot_stacks", "90607"],
    HAS_FIVE_ELEMENTS_HEAVENLY_MARROW_RHYTHM: [
        "five_elements_heavenly_marrow_rhythm_stacks", "13507"],
    HAS_HEAVENLY_MARROW_GOURD: [
        "heavenly_marrow_gourd_stacks", "93501"],
    HAS_REGEN_TUNE: ["regen_tune_stacks", "33401"],
    HAS_TOXIN_IMMUNITY: ["toxin_immunity_stacks", "24201"],
    HAS_SWORD_IN_SHEATHED: ["sword_in_sheathed_stacks"],
    HAS_ANTHOMANIA_FORMATION: [
        "anthomania_formation_stacks", "35501"],
    HAS_MOTIONLESS_TUTELARY_FORMATION: [
        "motionless_tutelary_formation_stacks", "35403"],
    HAS_SCUTTURTLE_FORMATION: [
        "scutturtle_formation_stacks", "35201"],
    HAS_THUNDERPHILIA_FORMATION: [
        "thunderphilia_formation_stacks", "35101"],
    HAS_FORCE_OF_WATER: ["force_of_water",
        "HAS_WATER_SPIRIT_SPRING_RAIN",
        "HAS_WATER_SPIRIT_SPRING",
        "HAS_FIVE_ELEMENTS_ANIMA",
        "HAS_METAL_SPIRIT_RHYTHM_WATER",
        "13110", "13209", "13210", "13409", "13505", "23105",
        "23502", "93401"],
    HAS_METAL_SPIRIT_RHYTHM_WATER: ["23302"],
    HAS_HARD_BAMBOO: ["hard_bamboo_stacks", "36102"],
    HAS_XUANMING_REGEN_TUNE: [
        "xuanming_regen_tune_heal_stacks",
        "xuanming_regen_tune_hurt_stacks", "90402"],
    HAS_THUNDERBOLT_TUNE: ["thunderbolt_tune_stacks", "92403"],
    HAS_METAL_SPIRIT_CHOKEHOLD: [
        "metal_spirit_chokehold_stacks", "23201"],
    HAS_IF_PLAYED_CONTINUOUS: [
        "35103", "35203", "35303", "35503"],
    HAS_UNRESTRAINED_SWORD_TWIN_DRAGONS: [
        "unrestrained_sword_twin_dragons_stacks", "21503"],
    HAS_STRIKE_TWICE: ["strike_twice_stacks", "12505", "80505"],
    HAS_CRASH_FIST_DOUBLE: ["crash_fist_double_stacks", "24402"],
    HAS_SWIFT_BURNING_SEAL: ["swift_burning_seal_stacks"],
    HAS_OTHER_SWORD_FORMATION_DECK_COUNT: ["21303"],
    HAS_SWORD_FORMATION_DECK_COUNT: [
        "HAS_OTHER_SWORD_FORMATION_DECK_COUNT"],
    HAS_FLYING_BRUSH: ["flying_brush_stacks",
        "HAS_SHADOW_OWL_REISHI", "34501"],
    HAS_SHADOW_OWL_REISHI: ["shadow_owl_reishi_stacks"],
    HAS_CLOUD_SWORD_CHAIN_COUNT: [
        "HAS_STEP_MOON_INTO_CLOUD",
        "11102", "11103", "11201", "11202", "11203", "11302",
        "11304", "11401", "11402", "11501", "11502", "21201",
        "21602", "61101", "61401", "71402", "91403", "91502",
        "91505"],
    HAS_ENDURANCE_AS_CLOUD_SEA: ["endurance_as_cloud_sea_stacks"],
    HAS_ULTIMATE_OVERCOME_FORMATION: [
        "ultimate_overcome_formation_stacks", "93502"],
    HAS_HAS_PLAYED_MUSICIAN_CARD: ["33101", "33303", "33503"],
    HAS_CHORD_IN_TUNE: ["33503"],
    HAS_PREEMPTIVE_STRIKE: ["preemptive_strike_stacks", "22502"],
    HAS_ACT_UNDERHAND: ["act_underhand_stacks"],
    HAS_POST_ACTION: [
        "12112", "12211", "12310", "12311", "12409", "12506",
        "22202", "62201", "72501", "72502", "92301", "92503",
        "90605"],
    HAS_EXCHANGE_CARD_CHANCE: ["HAS_THREE_TAILED_CAT"],
    HAS_CLOUD_SWORD_SOFTHEART_AND_FRIENDS: [
        "HAS_CLOUD_SWORD_SOFTHEART",
        "HAS_LITHE_AS_CAT",
        "HAS_P2_RULE_OF_THE_CLOUD",
        "HAS_P3_RULE_OF_THE_CLOUD",
        "HAS_P4_RULE_OF_THE_CLOUD",
        "HAS_P5_RULE_OF_THE_CLOUD",
        "HAS_CLOUD_SWORD_CLEAR_HEART"],
    HAS_CLOUD_SWORD_SOFTHEART: [
        "cloud_sword_softheart_stacks", "11301"],
    HAS_LITHE_AS_CAT: ["lithe_as_cat_stacks"],
    HAS_P2_RULE_OF_THE_CLOUD: ["p2_rule_of_the_cloud_stacks"],
    HAS_P3_RULE_OF_THE_CLOUD: ["p3_rule_of_the_cloud_stacks"],
    HAS_P4_RULE_OF_THE_CLOUD: ["p4_rule_of_the_cloud_stacks"],
    HAS_P5_RULE_OF_THE_CLOUD: ["p5_rule_of_the_cloud_stacks"],
    HAS_CLOUD_SWORD_CLEAR_HEART: ["cloud_sword_clear_heart_stacks",
        "quench_of_sword_heart_cloud_stacks"],
    HAS_ASTRAL_DIVINATION_HEXAGRAM: ["astral_divination_hexagram_stacks"],
    HAS_SWORD_FORMATION_GUARD: [
        "HAS_P2_SWORD_FORMATION_GUARD",
        "HAS_P3_SWORD_FORMATION_GUARD",
        "HAS_P4_SWORD_FORMATION_GUARD",
        "HAS_P5_SWORD_FORMATION_GUARD"],
    HAS_P2_SWORD_FORMATION_GUARD: ["p2_sword_formation_guard_stacks"],
    HAS_P3_SWORD_FORMATION_GUARD: ["p3_sword_formation_guard_stacks"],
    HAS_P4_SWORD_FORMATION_GUARD: ["p4_sword_formation_guard_stacks"],
    HAS_P5_SWORD_FORMATION_GUARD: ["p5_sword_formation_guard_stacks"],
    HAS_BONUS_FORCE: ["14506"],


};


// Define the features we want to enable
const defines = {};
for (let x in deps) {
    defines[x] = true;
}

// Get the input file from command line arguments
const args = process.argv.slice(2);
if (args.length !== 1) {
    console.error('Usage: node preprocess.js <input-file>');
    process.exit(1);
}

const inputFile = args[0];

try {
    // Read the input file
    const sourceCode = fs.readFileSync(inputFile, 'utf8');
    
    // Process the code
    const processedCode = preprocessJavaScript(sourceCode, defines);
    
    // Output to stdout
    process.stdout.write(processedCode);
} catch (err) {
    console.error('Error:', err.message);
    process.exit(1);
}